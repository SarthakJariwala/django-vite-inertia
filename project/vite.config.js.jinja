import { join, resolve } from "node:path";
{% if frontend == 'vue' %}
import vue from "@vitejs/plugin-vue";
{% elif frontend == 'react' %}
import react from '@vitejs/plugin-react';
{% elif frontend == 'svelte' %}
import svelte from '@sveltejs/vite-plugin-svelte';
{% endif %}
import { defineConfig, loadEnv } from "vite";
{% if tailwind_css %}
import postcssImport from "postcss-import";
import postcssSimpleVars from "postcss-simple-vars";
import tailwindcssNesting from "tailwindcss/nesting";
import tailwindcss from "tailwindcss";
import autoprefixer from "autoprefixer";

const postcssConfig = {
  plugins: [
    postcssImport(),
    postcssSimpleVars(),
    tailwindcssNesting(),
    tailwindcss(),
    autoprefixer(),
  ],
};
{% endif %}

export default defineConfig((mode) => {
	const env = loadEnv(mode, process.cwd(), "");

	const INPUT_DIR = "./src";
	const OUTPUT_DIR = "./src/dist";

	return {
		plugins: [
			{% if frontend == 'vue' %}vue()
			{% elif frontend == 'react' %}react()
			{% elif frontend == 'svelte' %}svelte(){% endif %}
		],
		resolve: {
			alias: {
				"@": resolve(INPUT_DIR),
				{% if frontend == 'vue' %}vue: "vue/dist/vue.esm-bundler.js",{% endif %}
			},
		},
		root: resolve(INPUT_DIR),
		base: "/static/",
		{% if tailwind_css %}
		css: {
			postcss: postcssConfig,
		},
		{% endif %}
		server: {
			host: "0.0.0.0",
			port: env.DJANGO_VITE_DEV_SERVER_PORT || 5173,
			watch: {
				usePolling: true,
			},
		},
		build: {
			manifest: "manifest.json",
			emptyOutDir: true,
			outDir: resolve(OUTPUT_DIR),
			rollupOptions: {
				input: {
					main: join(INPUT_DIR, "/js/main.js"),
					css: join(INPUT_DIR, "/css/main.css"),
				},
			},
		},
	};
});
